# サーバアカウント管理の基本的な考え方と棚卸し例
## 1. 基本方針

1. **ローカルユーザー一覧を把握する**
2. **管理者権限を持つユーザーを確認する**
3. **一般ユーザーとサービスアカウントを区別する**
   - 一般ユーザー … 業務利用、基本は「表示のみ」権限  
   - サービスアカウント … OS/サービス用、通常ログイン不可
4. **棚卸しのチェック観点**
   - 管理者権限ユーザーが最小限か  
   - 一般ユーザーが不要に残っていないか  
   - サービスアカウントが誤って有効化されていないか  

---

## 2. 棚卸し例

### 2-1. DMZ仮想化サーバ (Windows)
#### ローカルアカウント確認

```powershell
$hostname = $env:COMPUTERNAME
$results = @()

foreach ($user in Get-LocalUser) {
    $groups = @()

    foreach ($group in Get-LocalGroup) {
        if (Get-LocalGroupMember $group.Name -Member $user.Name -ErrorAction SilentlyContinue) {
            $groups += $group.Name
        }
    }

    $results += [PSCustomObject]@{
        Host      = $hostname
        User      = $user.Name
        Enabled   = $user.Enabled
        LastLogon = $user.LastLogon
        Groups    = ($groups -join ",")
    }
}

$results | Export-Csv "C:\$hostname-localusers-groups.csv" -NoTypeInformation -Encoding UTF8

```

```出力例
"Host","User","Enabled","LastLogon","Groups"
"FK-SSDMZ02","Administrator","False","2025/04/04 14:44:00","Administrators"
"FK-SSDMZ02","DefaultAccount","False",,"System Managed Accounts Group"
"FK-SSDMZ02","Guest","False",,"Guests"
"FK-SSDMZ02","ss-user","True","2025/09/05 14:30:28","Administrators"
"FK-SSDMZ02","WDAGUtilityAccount","False",,""
```

#### 管理者グループ所属確認 (Administrators)

```powershell
$hostname = $env:COMPUTERNAME
Get-LocalGroupMember Administrators |
  Select-Object @{Name="Host";Expression={$hostname}}, Name, ObjectClass |
  Export-Csv "C:\$hostname-localadmins.csv" -NoTypeInformation -Encoding UTF8
```

```出力例
"Host","Name","ObjectClass"
"FT-SSDMZ02","FT-SSDMZ02\Administrator","ユーザー"
"FT-SSDMZ02","FT-SSDMZ02\ss-user","ユーザー"
"FT-SSDMZ02","SEKISUIHOUSE\Domain Admins","グループ"
"FT-SSDMZ02","SEKISUIHOUSE\endo025","ユーザー"
"FT-SSDMZ02","SEKISUIHOUSE\hara074","ユーザー"
"FT-SSDMZ02","SEKISUIHOUSE\kajihara0046","ユーザー"
"FT-SSDMZ02","SEKISUIHOUSE\kanakubo002","ユーザー"
"FT-SSDMZ02","SEKISUIHOUSE\miura038","ユーザー"
"FT-SSDMZ02","SEKISUIHOUSE\watanabe1256","ユーザー"
"FT-SSDMZ02","SEKISUIHOUSE\yamazaki037","ユーザー"
```

SEKISUIHOUSE\Domain Admins のような ドメイングループの配下メンバーはサーバー側からは直接取得できない。  
そのグループに属する全ユーザーも管理者権限を持つが、誰が属しているかは Active Directory 側で確認が必要。

### 2-2. 中継サーバ (Linux, Rocky)
#### ローカルアカウント確認

```bash
getent passwd | awk -F: '($7!="/sbin/nologin" && $7!="/bin/false"){print $1}'
```

```出力例
root
sync
shutdown
halt
tss
sshd
ss-user
miura038
hara074
yamanaka020
chiba026
watanabe1256
kajihara0046
```

#### 管理者グループ所属確認 (root)
```
id root
getent group wheel
```
```出力例
wheel:x:10:
```
⇒ 管理者権限の表示がないのでroot のみ

#### Linux におけるユーザーと管理者権限の考え方

##### プライマリグループ
- Linux ではユーザー作成時に **ユーザー名と同じ名前のグループ** が自動で割り当てられる。
- 例: ユーザー `alice` を作成すると、同名のグループ `alice` がプライマリグループとして作成される。

##### 管理者権限の判定基準
Linux において「管理者権限を持つかどうか」を判断する際の基準は以下の 2 点。

1. **UID=0 (root)**
   - 特殊なユーザー ID。
   - このユーザーは無条件で管理者権限を持つ。

2. **wheel グループ（または sudo グループ）に所属**
   - 一般ユーザーであっても、`sudo` コマンドを利用して root 権限で操作可能。
   - RHEL 系では `wheel`、Ubuntu 系では `sudo` が管理者グループとして利用される。


## 3. まとめ
### 基本は ローカルユーザー一覧を確認し、管理者権限を特定する